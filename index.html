<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix NPI Final Report Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --header-bg: #e2efda; --type-bg: #fff2cc; --border-color: #000; --primary: #0056b3; --danger: #dc3545; --success: #198754; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .stage-card { background: #fdfdfd; border: 1px solid #ddd; padding: 15px; border-radius: 6px; margin-bottom: 15px; position: relative; border-left: 5px solid var(--primary); }
        .remove-btn { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .btn-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: var(--success); }
        .btn-preview { background: var(--primary); }
        .btn-pdf { background: var(--danger); }
        .btn-sheet { background: #217346; }
        .btn-edit { background: #ffc107; color: black; }
        
        /* Preview Styles */
        #preview-section { display: none; }
        .print-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .print-table th, .print-table td { border: 1px solid #000; padding: 6px; text-align: center; vertical-align: middle; }
        .status-open { color: red; font-weight: bold; }
        .status-closed { color: green; font-weight: bold; }
        .table-img { max-height: 70px; max-width: 100%; display: block; margin: 2px auto; }
    </style>
</head>
<body>

<div class="container">
    <div id="form-section">
        <div class="top-bar">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:60px;">
            <h2>NPI Data Entry</h2>
        </div>

        <div class="input-grid">
            <div><label>Date</label><input type="date" id="date" class="form-control"></div>
            <div><label>Model Name</label><input type="text" id="model" class="form-control"></div>
            <div><label>Colour</label><input type="text" id="colour" class="form-control"></div>
            <div><label>ODM</label><input type="text" id="odm" class="form-control"></div>
        </div>
        <div id="stages-container"></div>
        <div class="btn-row">
            <button class="btn btn-add" onclick="addStage()">+ Add Stage</button>
            <button class="btn btn-preview" onclick="generatePreview()">Preview Report</button>
        </div>
    </div>

    <div id="preview-section">
        <div class="btn-row" style="margin-bottom: 20px;">
            <button class="btn btn-edit" onclick="editForm()">Edit</button>
            <button class="btn btn-sheet" id="btn-save" onclick="sendToGoogleSheet()">Save to Google Sheet</button>
            <button class="btn btn-pdf" onclick="downloadPDF()">Download PDF</button>
        </div>
        <div id="printable-area">
            <h2 style="text-align:center;" id="p-title">NPI REPORT</h2>
            <table class="print-table">
                <thead>
                    <tr><th>Type</th><th>Process</th><th>Tools</th><th>Consumables</th><th>Curing</th><th>Observation</th><th>Status</th><th>Image</th></tr>
                </thead>
                <tbody id="p-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- PASTE YOUR NEW WEB APP URL HERE ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwiUZw8lSWIS0o82ASJlWLIr-J4L3uI0q5s023EVG5kp53QfZJ-v9dAmSueNamBhgJ3cw/exec"; 
    
    let stageCount = 0;
    window.onload = function() { document.getElementById('date').valueAsDate = new Date(); addStage(); };

    function addStage() {
        stageCount++;
        const div = document.createElement('div');
        div.className = 'stage-card';
        div.innerHTML = `
            <button class="remove-btn" onclick="this.parentElement.remove()">X</button>
            <div class="input-grid">
                <div><label>Type</label><input type="text" class="inp-type form-control" value="Stage-0${stageCount}"></div>
                <div><label>Status</label><select class="inp-status form-control"><option value="OPEN">OPEN</option><option value="CLOSED">CLOSED</option></select></div>
            </div>
            <div style="margin-bottom:10px"><label>Process</label><textarea class="inp-process form-control"></textarea></div>
            <div class="input-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div><label>Tool</label><input type="text" class="inp-tool form-control"></div>
                <div><label>Consumable</label><input type="text" class="inp-cons form-control"></div>
                <div><label>Curing</label><input type="text" class="inp-cure form-control"></div>
            </div>
            <div style="margin-bottom:10px"><label>Observation</label><textarea class="inp-obs form-control"></textarea></div>
            <div><label>Images</label><input type="file" class="inp-img form-control" multiple accept="image/*"></div>
        `;
        document.getElementById('stages-container').appendChild(div);
    }

    function generatePreview() {
        document.getElementById('p-title').innerText = (document.getElementById('model').value || "NPI") + " Report";
        const tbody = document.getElementById('p-tbody');
        tbody.innerHTML = "";
        
        document.querySelectorAll('.stage-card').forEach(card => {
            // Basic Preview Logic (Text only for speed)
            const type = card.querySelector('.inp-type').value;
            const status = card.querySelector('.inp-status').value;
            const process = card.querySelector('.inp-process').value;
            const tool = card.querySelector('.inp-tool').value;
            const cons = card.querySelector('.inp-cons').value;
            const cure = card.querySelector('.inp-cure').value;
            const obs = card.querySelector('.inp-obs').value;
            const color = status === 'OPEN' ? 'red' : 'green';

            // Preview Images handling
            const files = card.querySelector('.inp-img').files;
            let imgHTML = "";
            if(files.length > 0) imgHTML = "<span>(Images Attached)</span>"; 

            tbody.innerHTML += `<tr>
                <td style="background:#fff2cc">${type}</td>
                <td>${process}</td><td>${tool}</td><td>${cons}</td><td>${cure}</td>
                <td style="color:blue">${obs}</td>
                <td style="color:${color};font-weight:bold">${status}</td>
                <td>${imgHTML}</td>
            </tr>`;
        });
        document.getElementById('form-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
    }

    function editForm() {
        document.getElementById('form-section').style.display = 'block';
        document.getElementById('preview-section').style.display = 'none';
    }

    function downloadPDF() {
        const element = document.getElementById('printable-area');
        html2pdf().set({ margin: 0.2, filename: 'report.pdf', jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } }).from(element).save();
    }

    // --- MAIN FUNCTION TO SEND DATA AND IMAGES ---
    async function sendToGoogleSheet() {
        const btn = document.getElementById('btn-save');
        btn.innerText = "Uploading & Saving...";
        btn.disabled = true;

        const stagesData = [];
        const cards = document.querySelectorAll('.stage-card');

        for (let card of cards) {
            // Process Images for this stage
            const fileInput = card.querySelector('.inp-img');
            let imageFiles = [];
            
            if (fileInput.files.length > 0) {
                for (let file of fileInput.files) {
                    let base64 = await toBase64(file);
                    imageFiles.push({ name: file.name, data: base64 });
                }
            }

            stagesData.push({
                type: card.querySelector('.inp-type').value,
                status: card.querySelector('.inp-status').value,
                process: card.querySelector('.inp-process').value,
                tool: card.querySelector('.inp-tool').value,
                consumable: card.querySelector('.inp-cons').value,
                curing: card.querySelector('.inp-cure').value,
                observation: card.querySelector('.inp-obs').value,
                images: imageFiles // Sending base64 images
            });
        }

        const payload = {
            date: document.getElementById('date').value,
            model: document.getElementById('model').value,
            colour: document.getElementById('colour').value,
            odm: document.getElementById('odm').value,
            stages: stagesData
        };

        const formData = new FormData();
        formData.append('data', JSON.stringify(payload));

        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' })
        .then(() => {
            alert("Success! Data and Images saved to Google Sheet & Drive.");
            btn.innerText = "Save to Google Sheet";
            btn.disabled = false;
        })
        .catch(error => {
            console.error(error);
            alert("Error uploading.");
            btn.disabled = false;
        });
    }

    // Helper to convert image to base64
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

</script>
</body>
</html>
