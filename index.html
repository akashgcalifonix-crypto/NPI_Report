<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Observation Report - Califonix</title>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --header-bg: #e2efda; /* Light Green */
            --type-bg: #fff2cc;   /* Light Yellow */
            --border-color: #000;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        
        /* Input Form Styling */
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        .form-header img { height: 60px; }
        
        .input-group { margin-bottom: 15px; }
        label { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .stage-box { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fff; border-left: 5px solid var(--primary-color); position: relative; }
        .btn-remove { position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 3px 8px; cursor: pointer; }

        .btn-row { text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; color: white; }
        .btn-add { background: #28a745; }
        .btn-view { background: #0d6efd; }
        .btn-pdf { background: #dc3545; }
        .btn-back { background: #ffc107; color: black; }
        
        /* PREVIEW & PRINT STYLING (Professional Table) */
        #preview-section { display: none; background: white; padding: 20px; }
        
        .report-header {
            width: 100%;
            background-color: var(--header-bg);
            text-align: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 0;
        }
        .report-header h2 { margin: 5px 0; color: #000; font-size: 22px; text-transform: uppercase; }
        .logo-print { height: 50px; vertical-align: middle; margin-right: 15px; }

        .custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            font-family: 'Arial', sans-serif;
        }
        .custom-table th, .custom-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            vertical-align: middle;
            text-align: center;
        }
        .custom-table th {
            background-color: white; /* Headers are white or custom */
            font-weight: bold;
            color: #000;
        }
        /* Specific Column Widths */
        .w-type { width: 10%; background-color: var(--type-bg); }
        .w-process { width: 25%; text-align: left; }
        .w-tool { width: 10%; }
        .w-consumable { width: 10%; }
        .w-curing { width: 8%; }
        .w-obs { width: 22%; text-align: left; color: blue; font-weight: 500; }
        .w-img { width: 15%; }

        /* Images in Table */
        .table-img {
            max-width: 100%;
            max-height: 80px;
            border: 1px solid #ccc;
            display: block;
            margin: 2px auto;
        }

        /* Image Thumbnails in Input Form */
        .thumb-preview img { height: 50px; margin: 5px; border: 1px solid #ccc; }
        
        /* Grid Layout for Form */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    
    <!-- === INPUT FORM === -->
    <div id="input-section">
        <div class="form-header">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
            <h3>Enter NPI Details</h3>
        </div>

        <div class="grid-4">
            <div><label>Date</label><input type="date" id="date"></div>
            <div><label>Model Name</label><input type="text" id="model" placeholder="Ex: Tws_Airdopes -161 Pro"></div>
            <div><label>Colour</label><input type="text" id="colour" placeholder="Black"></div>
            <div><label>ODM</label><input type="text" id="odm" placeholder="Foxconn"></div>
        </div>
        <hr>

        <div id="stages-container"></div>

        <div class="btn-row">
            <button class="btn-add" onclick="addStage()">+ Add Stage</button>
            <button class="btn-view" onclick="generatePreview()">Preview Report</button>
        </div>
    </div>

    <!-- === PREVIEW & PDF SECTION === -->
    <div id="preview-section">
        <div class="btn-row" style="margin-bottom: 20px; justify-content: flex-start;">
            <button class="btn-back" onclick="editForm()">Edit / Back</button>
            <button class="btn-pdf" onclick="downloadLandscapePDF()">Download PDF (Landscape)</button>
        </div>

        <!-- PRINTABLE AREA STARTS -->
        <div id="printable-area">
            <!-- Green Header Bar -->
            <div class="report-header">
                <!-- Using Flex to align Logo and Text -->
                <div style="display: flex; align-items: center; justify-content: center;">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo-print">
                    <h2 id="print-title">MODEL NAME NPI OBSERVATION REPORT</h2>
                </div>
                <div style="font-size: 12px; margin-top: 5px;">
                    Date: <span id="p-date"></span> | Colour: <span id="p-colour"></span> | ODM: <span id="p-odm"></span>
                </div>
            </div>

            <table class="custom-table">
                <thead>
                    <tr>
                        <th style="background-color: #fff;">Type</th> <!-- Standard Header -->
                        <th>Process</th>
                        <th>Equipment/Tool Used</th>
                        <th>Consumable Items</th>
                        <th>Curing Time</th>
                        <th>Observation</th>
                        <th>Reference Image</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
        <!-- PRINTABLE AREA ENDS -->
    </div>

</div>

<script>
    let stageCount = 0;
    
    // Set default date
    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date();
        addStage(); // Add first stage automatically
    };

    function addStage() {
        stageCount++;
        const container = document.getElementById('stages-container');
        const div = document.createElement('div');
        div.className = 'stage-box';
        div.id = `stage-${stageCount}`;
        
        div.innerHTML = `
            <button class="btn-remove" onclick="removeStage(${stageCount})">X</button>
            <div class="grid-4">
                <div>
                    <label>Type / Stage No</label>
                    <input type="text" class="inp-type" value="Offline 0${stageCount}" placeholder="Ex: Offline 01">
                </div>
                <div><label>Equipment/Tool</label><input type="text" class="inp-tool"></div>
                <div><label>Consumable</label><input type="text" class="inp-consumable"></div>
                <div><label>Curing Time</label><input type="text" class="inp-curing"></div>
            </div>
            <div style="margin-top:10px;">
                <label>Process</label>
                <textarea class="inp-process" rows="2"></textarea>
            </div>
            <div style="margin-top:10px;">
                <label>Observation</label>
                <textarea class="inp-obs" rows="2" style="color:blue;"></textarea>
            </div>
            <div style="margin-top:10px;">
                <label>Images (Select Multiple)</label>
                <input type="file" multiple accept="image/*" onchange="previewImages(this, ${stageCount})">
                <div class="thumb-preview" id="img-prev-${stageCount}"></div>
            </div>
        `;
        container.appendChild(div);
    }

    function removeStage(id) {
        document.getElementById(`stage-${id}`).remove();
    }

    function previewImages(input, id) {
        const container = document.getElementById(`img-prev-${id}`);
        container.innerHTML = "";
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement("img");
                    img.src = e.target.result;
                    container.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    function generatePreview() {
        // 1. Update Header Info
        const model = document.getElementById('model').value || "MODEL";
        document.getElementById('print-title').innerText = `${model} NPI Observation Report`;
        document.getElementById('p-date').innerText = document.getElementById('date').value;
        document.getElementById('p-colour').innerText = document.getElementById('colour').value;
        document.getElementById('p-odm').innerText = document.getElementById('odm').value;

        // 2. Build Table Rows
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        
        const stages = document.querySelectorAll('.stage-box');
        
        stages.forEach(stage => {
            const type = stage.querySelector('.inp-type').value;
            const process = stage.querySelector('.inp-process').value;
            const tool = stage.querySelector('.inp-tool').value;
            const consumable = stage.querySelector('.inp-consumable').value;
            const curing = stage.querySelector('.inp-curing').value;
            const obs = stage.querySelector('.inp-obs').value;
            
            // Get images
            const imgContainer = stage.querySelector('.thumb-preview');
            let imgHTML = "";
            if(imgContainer) {
                const imgs = imgContainer.getElementsByTagName('img');
                for(let img of imgs) {
                    imgHTML += `<img src="${img.src}" class="table-img">`;
                }
            }

            const row = `
                <tr>
                    <td class="w-type" style="background-color: #fff2cc;">${type}</td>
                    <td class="w-process" style="text-align:left;">${process}</td>
                    <td class="w-tool">${tool}</td>
                    <td class="w-consumable">${consumable}</td>
                    <td class="w-curing">${curing}</td>
                    <td class="w-obs" style="text-align:left; color:blue;">>> ${obs}</td>
                    <td class="w-img">${imgHTML}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // 3. Toggle View
        document.getElementById('input-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
    }

    function editForm() {
        document.getElementById('input-section').style.display = 'block';
        document.getElementById('preview-section').style.display = 'none';
    }

    function downloadLandscapePDF() {
        const element = document.getElementById('printable-area');
        const model = document.getElementById('model').value || "Report";
        
        const opt = {
            margin:       0.2,
            filename:     `${model}_NPI_Report.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' } // Landscape Mode
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
