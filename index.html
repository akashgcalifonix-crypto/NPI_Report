<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Obervation Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #0056b3; --header: #e2efda; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Layout */
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; }
        .logo-area { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 50px; object-fit: contain; }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        
        /* Stages */
        .stage-card { background: #fff; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); position: relative; }
        .img-preview-box { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .thumb { height: 60px; border: 1px solid #ddd; padding: 2px; border-radius: 4px; }

        /* Buttons */
        .btn { padding: 8px 15px; border: none; cursor: pointer; color: white; border-radius: 4px; font-weight: 600; margin-right: 5px; }
        .btn-add { background: #198754; } 
        .btn-preview { background: #0d6efd; } 
        .btn-save { background: #198754; }
        .btn-pdf { background: #dc3545; }
        .btn-dash { background: #6610f2; }
        .btn-back { background: #ffc107; color: black; }
        .btn-edit { background: #fd7e14; padding: 5px 10px; font-size: 12px; }
        .btn-del { background: #dc3545; padding: 5px 10px; font-size: 12px; }

        /* Dashboard Table */
        .dash-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .dash-table th, .dash-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .dash-table th { background-color: var(--primary); color: white; }
        .dash-table tr:hover { background-color: #f1f1f1; }

        /* --- PDF & PRINT FIXES --- */
        #printable { width: 100%; background: white; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; table-layout: fixed; }
        .print-table th, .print-table td { border: 1px solid black; padding: 5px; text-align: center; vertical-align: top; word-wrap: break-word; word-break: break-word; white-space: normal; }
        .print-table th:nth-child(1) { width: 8%; }  
        .print-table th:nth-child(2) { width: 20%; } 
        .print-table th:nth-child(6) { width: 25%; } 
        .print-table th:nth-child(8) { width: 15%; } 

        tr { page-break-inside: avoid; }
        .tbl-img { max-height: 80px; max-width: 90%; display: block; margin: 0 auto; }
        .status-OPEN { color: red; font-weight: bold; }
        .status-CLOSED { color: green; font-weight: bold; }

        /* Sections Visibility */
        #dashboard-section, #form-section, #preview-section { display: none; }
        
        /* Loader */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

<div id="loader"><h2>Processing...</h2></div>

<div class="container">
    
    <!-- === DASHBOARD PAGE === -->
    <div id="dashboard-section">
        <div class="top-bar">
            <div class="logo-area">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo-img" alt="Califonix" onerror="this.style.display='none'">
                <h2>NPI Dashboard</h2>
            </div>
            <button class="btn btn-add" onclick="showFormNew()">+ New Report</button>
        </div>
        <input type="text" id="dash-search" class="form-control" placeholder="Search Model..." onkeyup="filterDashTable()" style="margin-bottom:10px;">
        <table class="dash-table">
            <thead>
                <tr>
                    <th>Date</th><th>Model</th><th>Product Type</th><th>ODM</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="dash-tbody"></tbody>
        </table>
    </div>

    <!-- === FORM PAGE === -->
    <div id="form-section">
        <div class="top-bar">
            <div class="logo-area">
                <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo-img" alt="Califonix" onerror="this.style.display='none'">
                <h2>Observation Entry</h2>
            </div>
            <button class="btn btn-dash" onclick="loadDashboard()">Go to Dashboard</button>
        </div>

        <input type="hidden" id="edit-row-index"> 

        <div class="input-grid">
            <div><label>Date</label><input type="date" id="date" class="form-control"></div>
            <div><label>Model Name</label><input type="text" id="model" class="form-control" placeholder="Example: Buds 100"></div>
            <div><label>Product Type</label><input type="text" id="pType" class="form-control"></div>
            <div><label>Colour</label><input type="text" id="colour" class="form-control"></div>
            <div><label>ODM</label><input type="text" id="odm" class="form-control"></div>
        </div>

        <div id="stages-container"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-add" onclick="addStage()">+ Add Stage</button>
            <button class="btn btn-preview" onclick="generatePreview()">Preview Report</button>
        </div>
    </div>

    <!-- === PREVIEW & PDF PAGE === -->
    <div id="preview-section">
        <div class="top-bar">
            <button class="btn btn-back" onclick="document.getElementById('preview-section').style.display='none'; document.getElementById('form-section').style.display='block';">← Back to Form</button>
            <div>
                <button class="btn btn-save" id="btn-save" onclick="saveData()">Save to Sheet</button>
                <button class="btn btn-pdf" onclick="downloadPDF()">Download PDF</button>
            </div>
        </div>

        <div id="printable">
            <div style="border:1px solid black; background:var(--header); padding:15px;">
                <div style="display:flex; align-items:center; border-bottom:1px solid #999; padding-bottom:10px; margin-bottom:10px;">
                    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:55px; margin-right:20px;" alt="Califonix" onerror="this.style.display='none'">
                    <h2 style="margin:0; flex-grow:1; text-align:center;">NPI OBSERVATION REPORT</h2>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:13px;">
                    <span id="pr-date"></span> <span id="pr-model"></span> <span id="pr-odm"></span>
                </div>
            </div>

            <table class="print-table">
                <thead>
                    <tr style="background:#fff2cc;">
                        <th>Type</th><th>Process</th><th>Tool Used</th><th>Consumables</th>
                        <th>Curing</th><th>Observation</th><th>Status</th><th>Image</th>
                    </tr>
                </thead>
                <tbody id="pr-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ===========================================
    // ⚠️ REPLACE THIS WITH YOUR DEPLOYMENT URL
    // ===========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzAlgu4ao926ZoMfnnZr5aqkuiM0zJpTw8G4GSTJX0WlcQFDCYuZlLIHc8slP84qiPV/exec"; 
    // ===========================================

    let stageCount = 0;
    let allReports = []; 

    window.onload = () => { 
        loadDashboard(); 
    };

    function showFormNew() {
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('form-section').style.display = 'block';
        resetForm();
    }

    function resetForm() {
        document.getElementById('edit-row-index').value = ""; 
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('model').value = "";
        document.getElementById('pType').value = "";
        document.getElementById('colour').value = "";
        document.getElementById('odm').value = "";
        document.getElementById('stages-container').innerHTML = "";
        stageCount = 0;
        addStage();
    }

    function addStage(data = null) {
        stageCount++;
        const div = document.createElement('div');
        div.className = 'stage-card';
        div.innerHTML = `
            <button onclick="this.parentElement.remove()" style="position:absolute; right:10px; top:10px; background:red; color:white; border:none; border-radius:3px;">X</button>
            <div class="input-grid">
                <div><label>Stage Type</label><input class="form-control inp-type" value="${data ? data.type : 'Stage ' + (stageCount < 10 ? '0'+stageCount : stageCount)}"></div>
                <div><label>Status</label><select class="form-control inp-status">
                    <option value="OPEN" ${data && data.status=='OPEN'?'selected':''}>OPEN</option>
                    <option value="CLOSED" ${data && data.status=='CLOSED'?'selected':''}>CLOSED</option>
                </select></div>
            </div>
            <label>Process</label><textarea class="form-control inp-process" rows="2">${data ? data.process : ''}</textarea>
            <div class="input-grid" style="margin-top:10px;">
                <input placeholder="Tool" class="form-control inp-tool" value="${data ? data.tool : ''}">
                <input placeholder="Consumables" class="form-control inp-cons" value="${data ? data.consumable : ''}">
                <input placeholder="Curing" class="form-control inp-cure" value="${data ? data.curing : ''}">
            </div>
            <label>Observation</label><textarea class="form-control inp-obs" rows="2">${data ? data.observation : ''}</textarea>
            
            <label>Images</label>
            <input type="file" multiple class="form-control inp-img" onchange="handleImageSelect(this)">
            <input type="hidden" class="inp-b64-store">
            <div class="img-preview-box"></div>
        `;
        document.getElementById('stages-container').appendChild(div);

        if(data && data.images && data.images.length > 0) {
            const previewBox = div.querySelector('.img-preview-box');
            const hiddenStore = div.querySelector('.inp-b64-store');
            hiddenStore.value = JSON.stringify(data.images);
            data.images.forEach(imgObj => {
                let src = imgObj.data ? imgObj.data : imgObj; 
                previewBox.innerHTML += `<img src="${src}" class="thumb">`;
            });
        }
    }

    async function handleImageSelect(input) {
        const previewBox = input.parentElement.querySelector('.img-preview-box');
        const hiddenStore = input.parentElement.querySelector('.inp-b64-store');
        previewBox.innerHTML = "";
        
        let fileDataArray = [];
        if (input.files) {
            for (let file of input.files) {
                let b64 = await new Promise(resolve => {
                    let reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                fileDataArray.push({ name: file.name, data: b64 });
                previewBox.innerHTML += `<img src="${b64}" class="thumb">`;
            }
        }
        hiddenStore.value = JSON.stringify(fileDataArray);
    }

    function loadDashboard() {
        document.getElementById('loader').style.display = 'flex';
        fetch(SCRIPT_URL + "?action=getAll")
        .then(r => r.json())
        .then(data => {
            allReports = data; // Store all data in global variable
            renderTable(data);
            document.getElementById('dashboard-section').style.display = 'block';
            document.getElementById('form-section').style.display = 'none';
            document.getElementById('preview-section').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
        })
        .catch(e => {
            document.getElementById('loader').style.display = 'none';
            console.error(e);
            alert("Connection Error or Script Updated. Please Reload.");
            showFormNew();
        });
    }

    function renderTable(data) {
        const tbody = document.getElementById('dash-tbody');
        tbody.innerHTML = "";
        if(data.length === 0) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>No Records Found</td></tr>"; return; }
        
        // Show latest first
        data.slice().reverse().forEach(row => {
            // FIX: We now pass only the rowIndex (ID), NOT the full data string
            tbody.innerHTML += `
                <tr>
                    <td>${new Date(row.date).toLocaleDateString()}</td>
                    <td><b>${row.model}</b></td>
                    <td>${row.productType}</td>
                    <td>${row.odm}</td>
                    <td>
                        <button class="btn btn-preview" style="padding:4px 8px; font-size:11px;" onclick="quickPreview(${row.rowIndex})">View</button>
                        <button class="btn btn-edit" onclick="editReport(${row.rowIndex})">Edit</button>
                        <button class="btn btn-del" onclick="deleteReport(${row.rowIndex})">Del</button>
                    </td>
                </tr>
            `;
        });
    }

    function filterDashTable() {
        const term = document.getElementById('dash-search').value.toLowerCase();
        const filtered = allReports.filter(r => r.model.toLowerCase().includes(term) || r.odm.toLowerCase().includes(term));
        renderTable(filtered);
    }

    function deleteReport(rowIndex) {
        if(!confirm("Delete this report from Dashboard?")) return;
        document.getElementById('loader').style.display = 'flex';
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: new URLSearchParams({ 
                data: JSON.stringify({ rowIndex: rowIndex }), 
                action: 'delete' 
            })
        }).then(r => r.json()).then(json => {
            alert(json.message);
            loadDashboard();
        });
    }

    // UPDATED: Now accepts rowIndex instead of full JSON string
    function editReport(rowIndex) {
        // Find the full data object from the global 'allReports' array
        const data = allReports.find(r => r.rowIndex == rowIndex);
        
        if (!data) {
            alert("Error: Data not found in memory. Please reload.");
            return;
        }

        showFormNew();
        document.getElementById('edit-row-index').value = data.rowIndex;
        try {
            const d = new Date(data.date);
            document.getElementById('date').value = d.toISOString().split('T')[0];
        } catch(e) {
            document.getElementById('date').valueAsDate = new Date();
        }
        
        document.getElementById('model').value = data.model;
        document.getElementById('pType').value = data.productType;
        document.getElementById('colour').value = data.colour;
        document.getElementById('odm').value = data.odm;

        document.getElementById('stages-container').innerHTML = "";
        stageCount = 0;
        if(data.stages && data.stages.length > 0) {
            data.stages.forEach(stage => addStage(stage));
        } else {
            addStage();
        }
    }

    // UPDATED: Now uses rowIndex
    function quickPreview(rowIndex) { 
        editReport(rowIndex); 
        generatePreview(); 
    }

    function generatePreview() {
        document.getElementById('form-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';

        const d = document.getElementById('date').value;
        const m = document.getElementById('model').value;
        const o = document.getElementById('odm').value;
        const t = document.getElementById('pType').value;

        document.getElementById('pr-date').innerHTML = `<b>Date:</b> ${d} <br> <b>Type:</b> ${t}`;
        document.getElementById('pr-model').innerHTML = `<b>Model:</b> ${m}`;
        document.getElementById('pr-odm').innerHTML = `<b>ODM:</b> ${o}`;

        const tbody = document.getElementById('pr-tbody');
        tbody.innerHTML = "";

        document.querySelectorAll('.stage-card').forEach(card => {
            const get = (sel) => card.querySelector(sel).value;
            const hiddenB64 = card.querySelector('.inp-b64-store').value;
            let images = [];
            if(hiddenB64) try { images = JSON.parse(hiddenB64); } catch(e){}

            let imgHtml = "";
            images.forEach(img => {
                let src = img.data ? img.data : img; 
                imgHtml += `<img src="${src}" class="tbl-img"><br>`;
            });

            tbody.innerHTML += `
                <tr>
                    <td><b>${get('.inp-type')}</b></td>
                    <td style="text-align:left;">${get('.inp-process')}</td>
                    <td>${get('.inp-tool')}</td><td>${get('.inp-cons')}</td><td>${get('.inp-cure')}</td>
                    <td style="color:blue; text-align:left;">${get('.inp-obs')}</td>
                    <td class="status-${get('.inp-status')}">${get('.inp-status')}</td>
                    <td>${imgHtml}</td>
                </tr>
            `;
        });
    }

    async function saveData() {
        const modelName = document.getElementById('model').value.trim();
        if(!modelName) { alert("Model Name is required to create a Sheet!"); return; }

        document.getElementById('loader').style.display = 'flex';
        
        const stages = [];
        document.querySelectorAll('.stage-card').forEach(card => {
            const get = (sel) => card.querySelector(sel).value;
            const hiddenB64 = card.querySelector('.inp-b64-store').value;
            let images = [];
            if(hiddenB64) try { images = JSON.parse(hiddenB64); } catch(e){}

            stages.push({
                type: get('.inp-type'), status: get('.inp-status'), process: get('.inp-process'),
                tool: get('.inp-tool'), consumable: get('.inp-cons'), curing: get('.inp-cure'),
                observation: get('.inp-obs'), images: images
            });
        });

        const rowIndex = document.getElementById('edit-row-index').value;
        const actionType = rowIndex ? "update" : "save";

        const payload = {
            rowIndex: rowIndex,
            date: document.getElementById('date').value,
            model: modelName,
            productType: document.getElementById('pType').value,
            colour: document.getElementById('colour').value,
            odm: document.getElementById('odm').value,
            stages: stages
        };

        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ data: JSON.stringify(payload), action: actionType })
            });
            const json = await res.json();
            alert(json.message);
            loadDashboard(); 
        } catch(e) {
            alert("Error: " + e);
            document.getElementById('loader').style.display = 'none';
        }
    }

    function downloadPDF() {
        const element = document.getElementById('printable');
        const opt = {
            margin: 0.2,
            filename: document.getElementById('model').value + '_NPI_Report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };
        
        const btn = document.querySelector('.btn-pdf');
        btn.innerText = "Generating...";
        html2pdf().set(opt).from(element).save().then(() => btn.innerText = "Download PDF");
    }
</script>
</body>
</html>
