<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix NPI Final Report Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --header-bg: #e2efda; --type-bg: #fff2cc; --primary: #0056b3; --success: #198754; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .top-bar { display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .stage-card { background: #fdfdfd; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); position: relative; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; margin: 5px; }
        .btn-add { background: var(--success); }
        .btn-preview { background: var(--primary); }
        .btn-sheet { background: #217346; }
        .btn-pdf { background: var(--danger); }
        .btn-edit { background: #ffc107; color: black; }
        
        /* Layout Utilities */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .status-open { color: red; font-weight: bold; }
        .status-closed { color: green; font-weight: bold; }
        #preview-section, #history-section { display: none; }
        
        /* Print Table */
        .print-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .print-table th, .print-table td { border: 1px solid #000; padding: 5px; text-align: center; }
        .col-type { background: var(--type-bg); }
        .table-img { max-height: 60px; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<div class="container">
    <!-- FORM SECTION -->
    <div id="form-section">
        <div class="top-bar">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" height="50">
            <h2>NPI Observation Form</h2>
            <button class="btn btn-edit" onclick="toggleHistory()">ðŸ“‚ History</button>
        </div>

        <div class="input-grid">
            <div><label>Date</label><input type="date" id="date" class="form-control"></div>
            <div><label>Model</label><input type="text" id="model" class="form-control" placeholder="Model Name"></div>
            <div><label>Colour</label><input type="text" id="colour" class="form-control" placeholder="Colour"></div>
            <div><label>ODM</label><input type="text" id="odm" class="form-control" placeholder="ODM"></div>
        </div>
        <hr>
        <div id="stages-container"></div>
        <div style="text-align:center">
            <button class="btn btn-add" onclick="addStage()">+ Add Stage</button>
            <button class="btn btn-preview" onclick="generatePreview()">Preview</button>
        </div>
    </div>

    <!-- PREVIEW SECTION -->
    <div id="preview-section">
        <div style="text-align:center; margin-bottom:20px;">
            <button class="btn btn-edit" onclick="editForm()">Back to Edit</button>
            <button class="btn btn-sheet" id="btn-save-sheet" onclick="sendToGoogleSheet()">Save to Google Sheet</button>
            <button class="btn btn-pdf" onclick="downloadPDF()">Download PDF</button>
        </div>
        <div id="printable-area">
            <div style="text-align:center; border:1px solid #000; padding:10px; background:#e2efda;">
                <h2 id="p-title" style="margin:0">REPORT</h2>
                <small>Date: <span id="p-date"></span> | ODM: <span id="p-odm"></span> | Colour: <span id="p-colour"></span></small>
            </div>
            <table class="print-table">
                <thead><tr><th>Type</th><th>Process</th><th>Tool</th><th>Consumable</th><th>Curing</th><th>Observation</th><th>Status</th><th>Image</th></tr></thead>
                <tbody id="p-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- HISTORY SECTION -->
    <div id="history-section">
        <h3>Saved Reports</h3>
        <div id="history-list"></div>
        <button class="btn btn-edit" onclick="toggleHistory()">Back</button>
    </div>
</div>

<script>
    // --- ðŸ›‘ PASTE YOUR NEW DEPLOYMENT URL HERE ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx7vw4Rzlsl5hiMp-4GdXeY9mFp8AIp69yOdTckO9slXHyW_DW2yhPLv8hbrsRYotWwgQ/exec";
    // ---------------------------------------------

    let stageCount = 0;
    let historyData = JSON.parse(localStorage.getItem('npi_history')) || [];

    window.onload = function() { document.getElementById('date').valueAsDate = new Date(); addStage(); };

    function addStage() {
        stageCount++;
        const div = document.createElement('div');
        div.className = 'stage-card';
        div.id = `stage-${stageCount}`;
        div.innerHTML = `
            <button style="float:right; background:red; color:white; border:none; cursor:pointer;" onclick="this.parentElement.remove()">X</button>
            <div class="input-grid">
                <div><label>Type</label><input type="text" class="inp-type form-control" value="Stage 0${stageCount}"></div>
                <div><label>Status</label><select class="inp-status form-control"><option value="OPEN">OPEN</option><option value="CLOSED">CLOSED</option></select></div>
            </div>
            <div style="margin:10px 0"><label>Process</label><textarea class="inp-process form-control" rows="2"></textarea></div>
            <div class="input-grid" style="grid-template-columns:1fr 1fr 1fr">
                <div><label>Tool</label><input type="text" class="inp-tool form-control"></div>
                <div><label>Consumable</label><input type="text" class="inp-cons form-control"></div>
                <div><label>Curing</label><input type="text" class="inp-cure form-control"></div>
            </div>
            <div style="margin:10px 0"><label>Observation</label><textarea class="inp-obs form-control" rows="2"></textarea></div>
            <div><label>Images</label><input type="file" class="inp-img form-control" multiple accept="image/*" onchange="previewImages(this, ${stageCount})">
            <div id="img-prev-${stageCount}" style="display:flex; gap:5px; margin-top:5px;"></div></div>
        `;
        document.getElementById('stages-container').appendChild(div);
    }

    function previewImages(input, id) {
        const box = document.getElementById(`img-prev-${id}`);
        box.innerHTML = "";
        Array.from(input.files).forEach(file => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.height = 50;
            box.appendChild(img);
        });
    }

    function generatePreview() {
        document.getElementById('p-title').innerText = (document.getElementById('model').value || "NPI") + " REPORT";
        document.getElementById('p-date').innerText = document.getElementById('date').value;
        document.getElementById('p-odm').innerText = document.getElementById('odm').value;
        document.getElementById('p-colour').innerText = document.getElementById('colour').value;
        
        const tbody = document.getElementById('p-tbody');
        tbody.innerHTML = "";
        
        document.querySelectorAll('.stage-card').forEach(card => {
            const row = `<tr>
                <td class="col-type">${card.querySelector('.inp-type').value}</td>
                <td style="text-align:left">${card.querySelector('.inp-process').value}</td>
                <td>${card.querySelector('.inp-tool').value}</td>
                <td>${card.querySelector('.inp-cons').value}</td>
                <td>${card.querySelector('.inp-cure').value}</td>
                <td style="text-align:left; color:blue;">>> ${card.querySelector('.inp-obs').value}</td>
                <td class="${card.querySelector('.inp-status').value === 'OPEN' ? 'status-open' : 'status-closed'}">${card.querySelector('.inp-status').value}</td>
                <td>${card.querySelector('[id^="img-prev"]').innerHTML.replace(/height="50"/g, 'class="table-img"')}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        document.getElementById('form-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
        
        // Auto Save to Local History
        const data = { id: Date.now(), model: document.getElementById('model').value, date: new Date().toLocaleDateString(), html: document.getElementById('printable-area').innerHTML };
        historyData.unshift(data);
        localStorage.setItem('npi_history', JSON.stringify(historyData));
    }

    function editForm() {
        document.getElementById('form-section').style.display = 'block';
        document.getElementById('preview-section').style.display = 'none';
    }

    function downloadPDF() {
        const elem = document.getElementById('printable-area');
        html2pdf().set({ margin: 0.2, filename: 'Report.pdf', jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' } }).from(elem).save();
    }

    function toggleHistory() {
        const sec = document.getElementById('history-section');
        const form = document.getElementById('form-section');
        if(sec.style.display === 'none') {
            form.style.display = 'none';
            sec.style.display = 'block';
            document.getElementById('history-list').innerHTML = historyData.map(item => 
                `<div style="border:1px solid #ccc; padding:10px; margin:5px; background:#fff;">
                    <strong>${item.model}</strong> (${item.date}) 
                    <button style="float:right;" onclick="loadHistory(${item.id})">View</button>
                </div>`
            ).join('');
        } else {
            sec.style.display = 'none';
            form.style.display = 'block';
        }
    }
    
    function loadHistory(id) {
        document.getElementById('history-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('printable-area').innerHTML = historyData.find(x => x.id === id).html;
    }

    // --- ðŸ”¥ COMPRESSED IMAGE UPLOAD FUNCTION ðŸ”¥ ---
    async function sendToGoogleSheet() {
        const btn = document.getElementById('btn-save-sheet');
        btn.innerText = "â³ Compressing & Uploading...";
        btn.disabled = true;
        btn.style.background = "orange";

        try {
            const stages = [];
            const cards = document.querySelectorAll('.stage-card');

            for (let card of cards) {
                const fileInput = card.querySelector('.inp-img');
                let imageFiles = [];
                
                if (fileInput.files.length > 0) {
                    for (let file of fileInput.files) {
                        // Compress Image before sending
                        let compressedBase64 = await compressImage(file);
                        imageFiles.push({ name: file.name, data: compressedBase64 });
                    }
                }

                stages.push({
                    type: card.querySelector('.inp-type').value,
                    status: card.querySelector('.inp-status').value,
                    process: card.querySelector('.inp-process').value,
                    tool: card.querySelector('.inp-tool').value,
                    consumable: card.querySelector('.inp-cons').value,
                    curing: card.querySelector('.inp-cure').value,
                    observation: card.querySelector('.inp-obs').value,
                    images: imageFiles
                });
            }

            const payload = {
                date: document.getElementById('date').value,
                model: document.getElementById('model').value,
                colour: document.getElementById('colour').value,
                odm: document.getElementById('odm').value,
                stages: stages
            };

            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));

            // Send to Google Script
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData, mode: 'no-cors' });

            alert("âœ… SUCCESS! Data Saved.");
            btn.innerText = "Save to Google Sheet";
            btn.style.background = "#217346";
            btn.disabled = false;

        } catch (error) {
            console.error(error);
            alert("âŒ FAILED: Check Internet or Script URL.");
            btn.innerText = "Try Again";
            btn.style.background = "red";
            btn.disabled = false;
        }
    }

    // --- Image Compressor Helper ---
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Resize to max 1000px
                    const MAX_SIZE = 1000;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert to JPEG with 0.7 quality
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }
</script>

</body>
</html>
