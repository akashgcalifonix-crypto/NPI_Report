<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix NPI Tool V4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #0056b3; --header: #e2efda; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Layout */
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        
        /* Stages */
        .stage-card { background: #fff; border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); position: relative; }
        .btn { padding: 8px 15px; border: none; cursor: pointer; color: white; border-radius: 4px; font-weight: 600; margin-right: 5px; }
        .btn-add { background: #198754; } 
        .btn-preview { background: #0d6efd; } 
        .btn-save { background: #198754; }
        .btn-pdf { background: #dc3545; }
        .btn-search { background: #6610f2; }
        .btn-back { background: #ffc107; color: black; }
        
        /* Print Table */
        #preview-section { display: none; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .print-table th, .print-table td { border: 1px solid black; padding: 6px; text-align: center; vertical-align: middle; }
        .tbl-img { max-height: 60px; display: block; margin: 0 auto; }
        .status-OPEN { color: red; font-weight: bold; }
        .status-CLOSED { color: green; font-weight: bold; }

        /* Loader */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

<div id="loader"><h2>Processing...</h2></div>

<div class="container">
    
    <!-- === FORM PAGE === -->
    <div id="form-section">
        <div class="top-bar">
            <h2>NPI Observation Report</h2>
            <div>
                <input type="text" id="search-inp" placeholder="Search Saved Model..." style="padding:8px;">
                <button class="btn btn-search" onclick="searchData()">üîç Search</button>
            </div>
        </div>

        <div class="input-grid">
            <div><label>Date</label><input type="date" id="date" class="form-control"></div>
            <div><label>Model Name</label><input type="text" id="model" class="form-control"></div>
            <div><label>Product Type</label><input type="text" id="pType" class="form-control" placeholder="e.g. Neckband / TWS"></div>
            <div><label>Colour</label><input type="text" id="colour" class="form-control"></div>
            <div><label>ODM</label><input type="text" id="odm" class="form-control"></div>
        </div>

        <div id="stages-container"></div>
        
        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-add" onclick="addStage()">+ Add Stage</button>
            <button class="btn btn-preview" onclick="showPreview(false)">Preview Report</button>
        </div>
    </div>

    <!-- === PREVIEW PAGE === -->
    <div id="preview-section">
        <div class="top-bar">
            <button class="btn btn-back" onclick="location.reload()">‚Üê Back / Reset</button>
            <div>
                <button class="btn btn-save" id="btn-save" onclick="saveData()">Save to Sheet</button>
                <button class="btn btn-pdf" onclick="downloadPDF()">Download PDF</button>
            </div>
        </div>

        <div id="printable">
            <div style="border:1px solid black; background:var(--header); padding:15px; text-align:center;">
                <h2 style="margin:0;">NPI OBSERVATION REPORT</h2>
                <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:13px;">
                    <span id="pr-date"></span> <span id="pr-model"></span> <span id="pr-odm"></span>
                </div>
            </div>

            <table class="print-table">
                <thead>
                    <tr style="background:#fff2cc;">
                        <th>Type</th><th>Process</th><th>Tool Used</th><th>Consumables</th>
                        <th>Curing</th><th>Observation</th><th>Status</th><th>Image</th>
                    </tr>
                </thead>
                <tbody id="pr-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ===========================================
    // ‚ö†Ô∏è PASTE YOUR NEW WEB APP URL HERE
    // ===========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzclq5O7p8lgFCCl1YvWqSsx6cVgmFtpyNk0Ai8Ar8iyvkn904V-rA8u9DMQuXyCTar/exec"; 
    // ===========================================

    let stageCount = 0;
    window.onload = () => { document.getElementById('date').valueAsDate = new Date(); addStage(); };

    function addStage() {
        stageCount++;
        const div = document.createElement('div');
        div.className = 'stage-card';
        div.innerHTML = `
            <button onclick="this.parentElement.remove()" style="position:absolute; right:10px; top:10px; background:red; color:white; border:none; border-radius:3px;">X</button>
            <div class="input-grid">
                <div><label>Stage Type</label><input class="form-control inp-type" value="Offline 0${stageCount}"></div>
                <div><label>Status</label><select class="form-control inp-status"><option value="OPEN">OPEN</option><option value="CLOSED">CLOSED</option></select></div>
            </div>
            <label>Process</label><textarea class="form-control inp-process" rows="2"></textarea>
            <div class="input-grid" style="margin-top:10px;">
                <input placeholder="Tool" class="form-control inp-tool">
                <input placeholder="Consumables" class="form-control inp-cons">
                <input placeholder="Curing" class="form-control inp-cure">
            </div>
            <label>Observation</label><textarea class="form-control inp-obs" rows="2"></textarea>
            <label>Images</label><input type="file" multiple class="form-control inp-img">
        `;
        document.getElementById('stages-container').appendChild(div);
    }

    function showPreview(isServer, data=null) {
        document.getElementById('form-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
        
        // Data Prep
        let header = {};
        let rows = [];

        if(isServer) {
            document.getElementById('btn-save').style.display = 'none';
            header = { 
                date: data[0].date, model: data[0].model, odm: data[0].odm, type: data[0].productType 
            };
            rows = data;
        } else {
            header = {
                date: document.getElementById('date').value,
                model: document.getElementById('model').value,
                odm: document.getElementById('odm').value,
                type: document.getElementById('pType').value
            };
            document.querySelectorAll('.stage-card').forEach(card => {
                const get = (sel) => card.querySelector(sel).value;
                rows.push({
                    type: get('.inp-type'), status: get('.inp-status'), process: get('.inp-process'),
                    tool: get('.inp-tool'), consumable: get('.inp-cons'), curing: get('.inp-cure'),
                    observation: get('.inp-obs'), tempFiles: card.querySelector('.inp-img').files
                });
            });
        }

        // Render Header
        document.getElementById('pr-date').innerHTML = `<b>Date:</b> ${header.date} <br> <b>Type:</b> ${header.type}`;
        document.getElementById('pr-model').innerHTML = `<b>Model:</b> ${header.model}`;
        document.getElementById('pr-odm').innerHTML = `<b>ODM:</b> ${header.odm}`;

        // Render Body
        const tbody = document.getElementById('pr-tbody');
        tbody.innerHTML = "";
        
        rows.forEach(row => {
            let imgHtml = "";
            if(row.images) {
                // Server Images
                row.images.split(',').forEach(url => { if(url.trim()) imgHtml += `<img src="${url}" class="tbl-img">` });
            } else if(row.tempFiles && row.tempFiles.length > 0) {
                // Local placeholder
                imgHtml = "<small>(Images pending Save)</small>";
            }

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold;">${row.type}</td>
                    <td style="text-align:left;">${row.process}</td>
                    <td>${row.tool}</td><td>${row.consumable}</td><td>${row.curing}</td>
                    <td style="color:blue; text-align:left;">${row.observation}</td>
                    <td class="status-${row.status}">${row.status}</td>
                    <td>${imgHtml}</td>
                </tr>
            `;
        });
    }

    async function saveData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const stages = [];
            for(let card of document.querySelectorAll('.stage-card')) {
                const get = (sel) => card.querySelector(sel).value;
                const fileInp = card.querySelector('.inp-img');
                
                let images = [];
                if(fileInp.files.length > 0) {
                    for(let file of fileInp.files) {
                        let b64 = await new Promise(r => { let reader=new FileReader(); reader.onload=e=>r(e.target.result); reader.readAsDataURL(file); });
                        images.push({ name: file.name, data: b64 });
                    }
                }
                stages.push({
                    type: get('.inp-type'), status: get('.inp-status'), process: get('.inp-process'),
                    tool: get('.inp-tool'), consumable: get('.inp-cons'), curing: get('.inp-cure'),
                    observation: get('.inp-obs'), images: images
                });
            }

            const payload = {
                date: document.getElementById('date').value,
                model: document.getElementById('model').value,
                productType: document.getElementById('pType').value,
                colour: document.getElementById('colour').value,
                odm: document.getElementById('odm').value,
                stages: stages
            };

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: new URLSearchParams({ data: JSON.stringify(payload) })
            });
            const json = await res.json();
            
            if(json.status === 'success') {
                alert("‚úÖ Saved Successfully!");
                location.reload();
            } else {
                alert("‚ùå Error: " + json.message);
            }
        } catch(e) {
            alert("‚ùå Connection Failed: " + e);
        }
        document.getElementById('loader').style.display = 'none';
    }

    function searchData() {
        const term = document.getElementById('search-inp').value;
        if(!term) return alert("Enter Model Name");
        
        document.getElementById('loader').style.display = 'flex';
        fetch(SCRIPT_URL + `?action=search&model=${encodeURIComponent(term)}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('loader').style.display = 'none';
            if(data.length > 0) showPreview(true, data);
            else alert("No records found.");
        })
        .catch(e => {
            document.getElementById('loader').style.display = 'none';
            alert("Search Error: " + e);
        });
    }

    function downloadPDF() {
        const el = document.getElementById('printable');
        html2pdf().set({ margin:0.2, filename:'NPI_Report.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'landscape'} }).from(el).save();
    }
</script>
</body>
</html>

