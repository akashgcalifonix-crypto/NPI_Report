<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Califonix NPI Advanced Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --p-green: #e2efda; --p-yellow: #fff2cc; --red-txt: #d93025; --green-txt: #188038; }
        body { font-family: 'Segoe UI', Arial; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* Header */
        .main-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #0056b3; padding-bottom: 15px; margin-bottom: 20px; }
        .main-header img { height: 60px; }
        
        /* Form Styling */
        .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; background: #fafafa; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { font-size: 13px; font-weight: bold; color: #444; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        /* Buttons */
        .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; }
        .btn-blue { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-yellow { background: #ffc107; color: #000; }
        .btn:hover { opacity: 0.8; }

        /* Status Colors */
        .status-open { color: var(--red-txt); font-weight: bold; }
        .status-closed { color: var(--green-txt); font-weight: bold; }

        /* Report Table Styling */
        #printable-area { display: none; margin-top: 30px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 8px; text-align: left; }
        .report-table th { background: #f2f2f2; }
        .type-col { background: var(--p-yellow); font-weight: bold; }
        .obs-text { color: #0056b3; white-space: pre-line; }

        /* History Section */
        #history-section { margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <!-- Form Section -->
    <div id="form-view">
        <div class="main-header">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
            <h2 style="margin:0">NPI Observation Dashboard</h2>
            <button class="btn btn-blue" onclick="showHistory()">View Saved Reports</button>
        </div>

        <div class="grid">
            <div><label>Date</label><input type="date" id="doc-date"></div>
            <div><label>Model Name</label><input type="text" id="doc-model" placeholder="Ex: Airdopes 161"></div>
            <div><label>Colour</label><input type="text" id="doc-colour" placeholder="Black"></div>
            <div><label>ODM</label><input type="text" id="doc-odm" placeholder="ODM Name"></div>
        </div>

        <div id="stages-container"></div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-green" onclick="addStage()">+ Add New Stage</button>
            <button class="btn btn-blue" onclick="generatePreview()">Preview & Save</button>
        </div>
    </div>

    <!-- Preview & Download Section -->
    <div id="preview-view" style="display:none;">
        <div class="main-header">
            <div>
                <button class="btn btn-yellow" onclick="backToEdit()">‚Üê Edit Form</button>
                <button class="btn btn-red" onclick="downloadPDF()">Download PDF (Landscape)</button>
                <button class="btn btn-green" onclick="saveToSheet()">Save to Google Sheet</button>
            </div>
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
        </div>

        <div id="printable-area" style="display:block;">
            <div style="background:var(--p-green); padding:10px; border:1px solid #000; text-align:center;">
                <h2 id="p-title" style="margin:5px 0;">REPORT</h2>
                <p id="p-meta" style="margin:0; font-size:13px;"></p>
            </div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Type/Stage</th>
                        <th>Process</th>
                        <th>Tools/Consumables</th>
                        <th>Curing</th>
                        <th>Observation</th>
                        <th>Status</th>
                        <th>Reference Image</th>
                    </tr>
                </thead>
                <tbody id="p-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- History / Model Wise Download Section -->
    <div id="history-view" style="display:none;">
        <h3>Saved Reports History</h3>
        <input type="text" id="searchModel" placeholder="Search by Model Name..." onkeyup="filterHistory()" style="margin-bottom:15px; width:300px;">
        <div id="history-list"></div>
        <button class="btn btn-blue" onclick="backToForm()">Back to Form</button>
    </div>
</div>

<script>
    let stageCount = 0;
    let savedReports = JSON.parse(localStorage.getItem('npi_reports') || '[]');

    window.onload = () => {
        document.getElementById('doc-date').valueAsDate = new Date();
        addStage();
    };

    function addStage() {
        stageCount++;
        const container = document.getElementById('stages-container');
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div><label>Stage/Type</label><input type="text" class="s-type" value="Offline 0${stageCount}"></div>
                <div><label>Tool Used</label><input type="text" class="s-tool"></div>
                <div><label>Consumable</label><input type="text" class="s-con"></div>
                <div><label>Status</label>
                    <select class="s-status">
                        <option value="OPEN">OPEN (Red)</option>
                        <option value="CLOSED">CLOSED (Green)</option>
                    </select>
                </div>
            </div>
            <div class="grid" style="grid-template-columns: 2fr 2fr 1fr;">
                <div><label>Process (As per SOP)</label><textarea class="s-proc" rows="2"></textarea></div>
                <div><label>Observation</label><textarea class="s-obs" rows="2"></textarea></div>
                <div><label>Images</label><input type="file" multiple accept="image/*" onchange="handleImgs(this, ${stageCount})"></div>
            </div>
            <div id="img-preview-${stageCount}" style="display:flex; gap:5px; margin-top:5px;"></div>
        `;
        container.appendChild(div);
    }

    function handleImgs(input, id) {
        const prev = document.getElementById(`img-preview-${id}`);
        prev.innerHTML = "";
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => prev.innerHTML += `<img src="${e.target.result}" style="height:50px; border:1px solid #ccc;">`;
            r.readAsDataURL(f);
        });
    }

    function generatePreview() {
        const model = document.getElementById('doc-model').value || "NPI";
        document.getElementById('p-title').innerText = `${model} NPI OBSERVATION REPORT`;
        document.getElementById('p-meta').innerText = `Date: ${document.getElementById('doc-date').value} | Colour: ${document.getElementById('doc-colour').value} | ODM: ${document.getElementById('doc-odm').value}`;
        
        const tbody = document.getElementById('p-tbody');
        tbody.innerHTML = "";
        
        document.querySelectorAll('.card').forEach(card => {
            const status = card.querySelector('.s-status').value;
            const statusClass = status === 'OPEN' ? 'status-open' : 'status-closed';
            
            tbody.innerHTML += `
                <tr>
                    <td class="type-col">${card.querySelector('.s-type').value}</td>
                    <td>${card.querySelector('.s-proc').value}</td>
                    <td>${card.querySelector('.s-tool').value}<br><small>${card.querySelector('.s-con').value}</small></td>
                    <td>-</td>
                    <td class="obs-text">>> ${card.querySelector('.s-obs').value}</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${card.querySelector('[id^="img-preview"]').innerHTML}</td>
                </tr>
            `;
        });

        document.getElementById('form-view').style.display = 'none';
        document.getElementById('preview-view').style.display = 'block';
        
        // Auto-save to Local History
        saveToLocal();
    }

    function saveToLocal() {
        const report = {
            id: Date.now(),
            model: document.getElementById('doc-model').value,
            date: document.getElementById('doc-date').value,
            html: document.getElementById('printable-area').innerHTML
        };
        savedReports.push(report);
        localStorage.setItem('npi_reports', JSON.stringify(savedReports));
    }

    function showHistory() {
        document.getElementById('form-view').style.display = 'none';
        document.getElementById('history-view').style.display = 'block';
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = savedReports.map(r => `
            <div class="history-item">
                <span><strong>${r.model}</strong> (${r.date})</span>
                <div>
                    <button class="btn btn-blue" onclick="loadReport(${r.id})">Download</button>
                    <button class="btn btn-red" onclick="deleteReport(${r.id})">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function loadReport(id) {
        const r = savedReports.find(x => x.id === id);
        document.getElementById('printable-area').innerHTML = r.html;
        document.getElementById('history-view').style.display = 'none';
        document.getElementById('preview-view').style.display = 'block';
    }

    function backToEdit() {
        document.getElementById('form-view').style.display = 'block';
        document.getElementById('preview-view').style.display = 'none';
    }

    function backToForm() {
        document.getElementById('history-view').style.display = 'none';
        document.getElementById('form-view').style.display = 'block';
    }

    function downloadPDF() {
        const element = document.getElementById('printable-area');
        const model = document.getElementById('doc-model').value || "Report";
        html2pdf().set({
            margin: 0.3,
            filename: `${model}_NPI_Report.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        }).from(element).save();
    }

    function saveToSheet() {
        alert("Connecting to Google Sheets... (Make sure Script URL is added in code)");
        // Logic same as previous version - use your Script URL here.
    }

    function deleteReport(id) {
        savedReports = savedReports.filter(x => x.id !== id);
        localStorage.setItem('npi_reports', JSON.stringify(savedReports));
        renderHistory();
    }

    function filterHistory() {
        const val = document.getElementById('searchModel').value.toLowerCase();
        const items = document.querySelectorAll('.history-item');
        items.forEach(it => {
            it.style.display = it.innerText.toLowerCase().includes(val) ? 'flex' : 'none';
        });
    }
</script>

</body>
</html>
